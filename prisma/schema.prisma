// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum per i ruoli utente
enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

// Enum per lo stato delle prenotazioni
enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

// Enum per i canali di acquisizione
enum BookingChannel {
  BOOKING_COM
  AIRBNB
  DIRECT
  OTHER
}

// Enum per le fonti di sincronizzazione iCal
enum ICalSource {
  AIRBNB
  BOOKING_COM
  OTHER
}

// Enum per i tipi di transazione
enum TransactionType {
  INCOME
  EXPENSE
}

// Enum per i tipi di stanza
enum RoomType {
  SINGLE      // Camera singola
  DOUBLE      // Camera doppia
  TWIN        // Camera doppia con letti separati
  TRIPLE      // Camera tripla
  QUAD        // Camera quadrupla
  SUITE       // Suite
  STUDIO      // Monolocale
  APARTMENT   // Appartamento intero
  DORMITORY   // Dormitorio
}

// Enum per i tipi di documento
enum DocumentType {
  CARTA_IDENTITA  // Carta d'identità
  PASSAPORTO      // Passaporto
  PATENTE         // Patente di guida
}

// Modello User - Gestione utenti/dipendenti
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(STAFF)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relazioni
  bookings           Booking[]
  transactions       Transaction[]
  expenses           Expense[]
  properties         PropertyAccess[]
  assignedTasks      StaffAssignment[] @relation("AssignedTasks")
  createdAssignments StaffAssignment[] @relation("CreatedAssignments")

  @@index([email])
}

// Modello Property - Strutture/Immobili
model Property {
  id              String    @id @default(cuid())
  name            String
  address         String
  city            String
  country         String
  description     String?
  maxGuests       Int       // Ospiti totali della proprietà
  bedrooms        Int       // Camere totali
  bathrooms       Int       // Bagni totali
  hasRooms        Boolean   @default(false) // Se true, la proprietà ha stanze separate
  active          Boolean   @default(true)
  accessCodes     Json?     // Mappa di codici accesso (es: { "Portone": "1234", "Appartamento": "5678" })
  alloggiatiCredentials Json? // Credenziali per portale Alloggiati Web (username, password)
  isPropertyManager Boolean @default(false) // Se true, gestita da property manager
  propertyManagerPercentage Decimal? @db.Decimal(5, 2) // Percentuale property manager (es. 20.00)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relazioni
  rooms            Room[]
  bookings         Booking[]
  calendarEvents   CalendarEvent[]
  prices           PropertyPrice[]
  userAccess       PropertyAccess[]
  images           PropertyImage[]
  expenses         Expense[]
  staffAssignments StaffAssignment[]

  @@index([active])
  @@index([hasRooms])
}

// Modello GlobalSettings - Configurazione globale applicativa
model GlobalSettings {
  id                  String   @id @default("singleton")
  touristTaxRate      Decimal  @default(4.00) @db.Decimal(10, 2)
  touristTaxMaxNights Int      @default(4)
  touristTaxExemptAge Int      @default(12)
  paypalEmail         String?
  revolutTag          String?
  bankAccountIBAN     String?
  bankAccountHolder   String?
  updatedAt           DateTime @updatedAt
}

// Modello Room - Stanze singole all'interno di una proprietà
model Room {
  id              String    @id @default(cuid())
  propertyId      String
  name            String    // Es: "Camera 101", "Stanza Blu"
  roomNumber      String?   // Numero stanza
  type            RoomType  @default(DOUBLE)
  description     String?
  maxGuests       Int       // Ospiti massimi per questa stanza
  beds            Int       // Numero di letti
  size            Float?    // Dimensione in mq
  hasPrivateBathroom Boolean @default(false)
  hasBalcony      Boolean   @default(false)
  hasKitchen      Boolean   @default(false)
  floor           Int?      // Piano
  active          Boolean   @default(true)
  basePrice       Decimal   @db.Decimal(10, 2) // Prezzo base per notte

  // Sincronizzazione calendari esterni (iCal)
  airbnbIcalUrl     String?   // URL del calendario iCal di Airbnb
  bookingComIcalUrl String?   // URL del calendario iCal di Booking.com
  lastSyncedAt      DateTime? // Ultima sincronizzazione effettuata

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relazioni
  property         Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  bookings         Booking[]           // Prenotazioni legacy (singola stanza)
  bookingRooms     BookingRoom[]       // Prenotazioni multi-stanza
  prices           RoomPrice[]
  images           RoomImage[]
  calendarEvents   RoomCalendarEvent[]
  staffAssignments StaffAssignment[]
  icalSyncs        ICalSync[]
  guestCheckIns    GuestCheckIn[]
  messages         RoomMessage[]

  @@index([propertyId])
  @@index([active])
  @@index([type])
}

// Enum per i tipi di messaggio
enum MessageType {
  CHECK_IN_INSTRUCTIONS  // Istruzioni per il check-in
  WELCOME                // Messaggio di benvenuto
  CHECKOUT               // Istruzioni checkout
  CUSTOM                 // Messaggio personalizzato
}

// Enum per il trigger di invio messaggio
enum MessageTrigger {
  ON_CONFIRMATION        // Quando la prenotazione viene confermata
  BEFORE_CHECKIN         // X ore/giorni prima del check-in
  ON_CHECKIN_DAY         // Il giorno del check-in
  AFTER_CHECKIN          // Dopo il check-in (es. follow-up)
  BEFORE_CHECKOUT        // X ore/giorni prima del check-out
  ON_CHECKOUT_DAY        // Il giorno del check-out
  MANUAL                 // Invio manuale
}

// Enum per il canale di invio
enum MessageChannel {
  EMAIL
  WHATSAPP
  BOTH
}

// Enum per lo stato del messaggio inviato
enum SentMessageStatus {
  PENDING    // In attesa di invio
  SENT       // Inviato con successo
  FAILED     // Invio fallito
  CANCELLED  // Annullato
}

// Modello RoomMessage - Messaggi personalizzabili per stanza
model RoomMessage {
  id              String         @id @default(cuid())
  roomId          String
  type            MessageType    @default(CHECK_IN_INSTRUCTIONS)
  name            String         // Nome descrittivo del messaggio (es. "Istruzioni Check-in")
  subject         String?        // Oggetto per email
  messageText     String         @db.Text // Contenuto del messaggio (supporta variabili come {guest_name})

  // Configurazione invio automatico
  trigger         MessageTrigger @default(MANUAL)     // Quando inviare
  triggerOffsetHours Int         @default(0)          // Offset in ore (es. -24 = 24h prima, 2 = 2h dopo)
  channel         MessageChannel @default(EMAIL)      // Canale di invio
  sendTime        String?        // Ora specifica di invio (es. "09:00") - opzionale

  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relazioni
  room            Room           @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sentMessages    SentMessage[]

  @@index([roomId])
  @@index([type])
  @@index([trigger])
  @@index([isActive])
}

// Modello SentMessage - Tracciamento messaggi inviati
model SentMessage {
  id              String            @id @default(cuid())
  bookingId       String
  messageId       String            // Riferimento al template RoomMessage
  channel         MessageChannel    // Canale usato per l'invio
  status          SentMessageStatus @default(PENDING)

  // Dettagli invio
  recipientEmail  String?           // Email destinatario
  recipientPhone  String?           // Telefono destinatario (per WhatsApp)
  subject         String?           // Oggetto effettivo inviato
  messageContent  String?           @db.Text // Contenuto effettivo inviato (con variabili sostituite)

  // Tracking
  scheduledFor    DateTime?         // Quando era programmato l'invio
  sentAt          DateTime?         // Quando è stato effettivamente inviato
  errorMessage    String?           // Messaggio di errore se fallito
  retryCount      Int               @default(0) // Numero di tentativi

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relazioni
  booking         Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  message         RoomMessage       @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([messageId])
  @@index([status])
  @@index([scheduledFor])
  @@index([channel])
}

// Modello PropertyImage - Immagini delle proprietà
model PropertyImage {
  id          String   @id @default(cuid())
  propertyId  String
  url         String   // URL dell'immagine
  filename    String   // Nome file
  isPrimary   Boolean  @default(false) // Immagine principale
  order       Int      @default(0) // Ordine di visualizzazione
  createdAt   DateTime @default(now())

  // Relazioni
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([isPrimary])
}

// Modello RoomImage - Immagini delle stanze
model RoomImage {
  id          String   @id @default(cuid())
  roomId      String
  url         String   // URL dell'immagine
  filename    String   // Nome file
  isPrimary   Boolean  @default(false) // Immagine principale
  order       Int      @default(0) // Ordine di visualizzazione
  createdAt   DateTime @default(now())

  // Relazioni
  room        Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([isPrimary])
}

// Modello PropertyAccess - Permessi di accesso alle proprietà per utente
model PropertyAccess {
  id          String   @id @default(cuid())
  userId      String
  propertyId  String
  createdAt   DateTime @default(now())

  // Relazioni
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

// Modello PropertyPrice - Prezzi personalizzati per struttura e periodo
model PropertyPrice {
  id            String   @id @default(cuid())
  propertyId    String
  startDate     DateTime
  endDate       DateTime
  pricePerNight Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relazioni
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([startDate, endDate])
}

// Modello RoomPrice - Prezzi personalizzati per stanza e periodo
model RoomPrice {
  id            String   @id @default(cuid())
  roomId        String
  startDate     DateTime
  endDate       DateTime
  pricePerNight Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relazioni
  room          Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([startDate, endDate])
}

// Modello Booking - Prenotazioni
model Booking {
  id               String         @id @default(cuid())
  bookingCode      String?        @unique // Codice univoco per check-in guest (es: BOOK-ABC123)
  propertyId       String
  roomId           String?        // DEPRECATED: usare bookingRooms per nuove prenotazioni
  guestName        String
  guestEmail       String
  guestPhone       String?
  checkIn          DateTime
  checkOut         DateTime
  guests           Int
  totalPrice       Decimal        @db.Decimal(10, 2)
  status           BookingStatus  @default(PENDING)
  channel          BookingChannel @default(DIRECT)
  channelBookingId String?        // ID della prenotazione sul canale esterno
  notes            String?

  // Tassa di Soggiorno
  touristTaxTotal  Decimal?       @db.Decimal(10, 2)
  touristTaxPaid   Boolean        @default(false)
  touristTaxPaymentProof String?  // URL screenshot pagamento

  // Sincronizzazione iCal
  importedFromIcal   Boolean  @default(false) // True se importata da calendario esterno
  externalCalendarId String?  // UID dell'evento nel calendario esterno

  createdById      String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relazioni
  property         Property       @relation(fields: [propertyId], references: [id])
  room             Room?          @relation(fields: [roomId], references: [id])
  createdBy        User           @relation(fields: [createdById], references: [id])
  transactions     Transaction[]
  guestCheckIns    GuestCheckIn[] // Dati check-in ospiti (questura)
  sentMessages     SentMessage[]  // Messaggi inviati per questa prenotazione
  bookingRooms     BookingRoom[]  // Stanze prenotate (relazione many-to-many)
  whatsappConversations WhatsAppConversation[] // Conversazioni WhatsApp collegate

  @@index([propertyId])
  @@index([roomId])
  @@index([checkIn, checkOut])
  @@index([status])
  @@index([channel])
  @@index([bookingCode])
  @@index([importedFromIcal])
  @@index([externalCalendarId])
}

// Modello BookingRoom - Tabella di join per prenotazioni multi-stanza
model BookingRoom {
  id        String   @id @default(cuid())
  bookingId String
  roomId    String
  createdAt DateTime @default(now())

  // Relazioni
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([bookingId, roomId]) // Una stanza può essere in una prenotazione una sola volta
  @@index([bookingId])
  @@index([roomId])
}

// Modello CalendarEvent - Eventi calendario per proprietà (blocchi manuali, manutenzione, etc.)
model CalendarEvent {
  id          String   @id @default(cuid())
  propertyId  String
  title       String
  startDate   DateTime
  endDate     DateTime
  isBlocked   Boolean  @default(true)  // Se true, la proprietà non è disponibile
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relazioni
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([startDate, endDate])
}

// Modello RoomCalendarEvent - Eventi calendario per stanze specifiche
model RoomCalendarEvent {
  id          String   @id @default(cuid())
  roomId      String
  title       String
  startDate   DateTime
  endDate     DateTime
  isBlocked   Boolean  @default(true)  // Se true, la stanza non è disponibile
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relazioni
  room        Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([startDate, endDate])
}

// Modello Transaction - Transazioni finanziarie (incassi)
model Transaction {
  id          String          @id @default(cuid())
  bookingId   String?
  amount      Decimal         @db.Decimal(10, 2)
  type        TransactionType
  description String
  date        DateTime        @default(now())
  createdById String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relazioni
  booking     Booking?        @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  createdBy   User            @relation(fields: [createdById], references: [id])

  @@index([bookingId])
  @@index([type])
  @@index([date])
}

// Modello Expense - Spese operative
model Expense {
  id          String   @id @default(cuid())
  propertyId  String?  // Opzionale - se null, è una spesa generale
  amount      Decimal  @db.Decimal(10, 2)
  category    String   // Es: Pulizia, Manutenzione, Utenze, etc.
  description String
  date        DateTime @default(now())
  receiptUrl  String?  // URL della ricevuta/fattura
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relazioni
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  createdBy   User      @relation(fields: [createdById], references: [id])

  @@index([propertyId])
  @@index([category])
  @@index([date])
}

// Enum per i tipi di task staff
enum StaffTaskType {
  CLEANING      // Pulizia
  MAINTENANCE   // Manutenzione
  CHECK_IN      // Gestione check-in
  CHECK_OUT     // Gestione check-out
  LAUNDRY       // Lavanderia
  INSPECTION    // Ispezione
  OTHER         // Altro
}

// Enum per lo stato dei task
enum StaffTaskStatus {
  PENDING       // In attesa
  IN_PROGRESS   // In corso
  COMPLETED     // Completato
  CANCELLED     // Annullato
}

// Modello StaffAssignment - Assegnazioni task per dipendenti
model StaffAssignment {
  id          String           @id @default(cuid())
  userId      String           // Dipendente assegnato
  propertyId  String?          // Proprietà (opzionale se c'è roomId)
  roomId      String?          // Stanza specifica (opzionale)
  date        DateTime         // Data dell'assegnazione
  taskType    StaffTaskType    // Tipo di task
  status      StaffTaskStatus  @default(PENDING)
  notes       String?          // Note e dettagli del task
  createdById String           // Chi ha creato l'assegnazione
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relazioni
  user        User      @relation("AssignedTasks", fields: [userId], references: [id], onDelete: Cascade)
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  room        Room?     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdBy   User      @relation("CreatedAssignments", fields: [createdById], references: [id])

  @@index([userId])
  @@index([propertyId])
  @@index([roomId])
  @@index([date])
  @@index([status])
}

// Stato del check-in
enum CheckInStatus {
  PENDING   // In attesa di approvazione/collegamento
  APPROVED  // Approvato e collegato a prenotazione
  REJECTED  // Rifiutato
}

// Modello GuestCheckIn - Dati check-in ospiti per la questura
model GuestCheckIn {
  id                  String        @id @default(cuid())
  groupId             String?       // ID per raggruppare ospiti dello stesso check-in
  bookingId           String?       // Opzionale - può essere collegato dopo
  status              CheckInStatus @default(PENDING) // Stato del check-in

  // Dati selezionati dall'ospite (per matching)
  selectedRoomId      String?       // Stanza selezionata dall'ospite
  selectedCheckIn     DateTime?     // Data check-in selezionata
  selectedCheckOut    DateTime?     // Data check-out selezionata

  // Numero ospiti totali e dati ospiti aggiuntivi
  numGuests           Int           @default(1)
  additionalGuests    Json?         // Array JSON con i dati degli altri ospiti

  // Dati contatto
  email               String?       // Email ospite (opzionale)
  phone               String?       // Telefono ospite (opzionale)
  contactPreference   String?       // Preferenza contatto: "whatsapp" o "email"

  // Dati anagrafici
  firstName           String        // Nome
  lastName            String        // Cognome
  sex                 String?       // Sesso: "M" o "F"
  nationality         String?       // Nazionalità (es. "Italia", "Germania")
  dateOfBirth         DateTime      // Data di nascita
  birthCity           String        // Città di nascita
  birthProvince       String        // Provincia di nascita
  fiscalCode          String?       // Codice fiscale (opzionale, necessario se richiesta fattura)

  // Documento
  documentType        DocumentType  // Tipo documento
  documentNumber      String        // Numero documento
  documentIssuePlace  String?       // Luogo rilascio documento
  documentFrontUrl    String?       // URL foto fronte documento
  documentBackUrl     String?       // URL foto retro documento

  // Esenzione Tassa di Soggiorno
  isExempt            Boolean      @default(false)
  exemptionReason     String?      // Motivo esenzione

  // Tassa di soggiorno - prova pagamento
  touristTaxPaymentProof String?   // URL screenshot pagamento tassa di soggiorno

  submittedAt         DateTime     @default(now()) // Quando il guest ha compilato il form
  submittedToPolice   Boolean      @default(false) // Se comunicato alla Questura
  submittedToPoliceAt DateTime?    // Quando è stato comunicato alla Questura
  dataAnonymized      Boolean      @default(false) // Se i dati sono stati anonimizzati per GDPR
  dataAnonymizedAt    DateTime?    // Quando i dati sono stati anonimizzati
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // Relazioni
  booking             Booking?     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  selectedRoom        Room?        @relation(fields: [selectedRoomId], references: [id])

  @@index([groupId])
  @@index([bookingId])
  @@index([status])
  @@index([selectedRoomId])
  @@index([fiscalCode])
  @@index([submittedAt])
  @@index([submittedToPolice])
}

// Modello ICalSync - Tracking sincronizzazione calendari iCal
model ICalSync {
  id           String     @id @default(cuid())
  roomId       String
  source       ICalSource // Fonte del calendario (AIRBNB, BOOKING_COM, OTHER)
  syncedAt     DateTime   @default(now()) // Quando è avvenuta la sincronizzazione
  success      Boolean    @default(true) // Se la sincronizzazione è riuscita
  eventsImported Int      @default(0) // Numero di eventi importati
  errorMessage String?    // Eventuale messaggio di errore
  createdAt    DateTime   @default(now())

  // Relazioni
  room         Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([source])
  @@index([syncedAt])
}

// Enum per la direzione del messaggio WhatsApp
enum MessageDirection {
  INCOMING  // Messaggio ricevuto dall'ospite
  OUTGOING  // Messaggio inviato dall'host
}

// Modello WhatsAppConversation - Conversazioni WhatsApp con gli ospiti
model WhatsAppConversation {
  id            String    @id @default(cuid())
  phoneNumber   String    @unique  // Numero WhatsApp (formato: +393331234567)
  guestName     String?             // Nome ospite se conosciuto
  bookingId     String?             // Collegamento opzionale a booking
  lastMessageAt DateTime  @default(now())
  unreadCount   Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relazioni
  booking       Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  messages      WhatsAppMessage[]

  @@index([phoneNumber])
  @@index([bookingId])
  @@index([lastMessageAt])
  @@index([unreadCount])
}

// Modello WhatsAppMessage - Singoli messaggi WhatsApp
model WhatsAppMessage {
  id              String            @id @default(cuid())
  conversationId  String
  direction       MessageDirection  // INCOMING o OUTGOING
  body            String            @db.Text
  mediaUrl        String?           // URL media allegato (immagini, documenti)
  twilioSid       String?           @unique  // SID Twilio per tracking
  status          String            @default("SENT")  // QUEUED, SENT, DELIVERED, READ, FAILED
  sentAt          DateTime          @default(now())
  createdAt       DateTime          @default(now())

  // Relazioni
  conversation    WhatsAppConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([sentAt])
  @@index([twilioSid])
  @@index([direction])
}
